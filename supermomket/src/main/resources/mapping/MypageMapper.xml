<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MypageDAO">

	<!-- 관리자 메뉴 -->
	<!-- 사용자 목록 보기(관리자) -->
	<select id="searchUsers" resultType="user">
	    SELECT *
	    FROM USER
	    WHERE
	    <if test="searchType != null and searchKeyword != null">
	        ${searchType} LIKE #{searchKeyword}
	    </if>
	    ORDER BY U_DATE DESC
	    LIMIT #{offset}, #{limit}
	</select>

	<select id="getSearchUserCount" resultType="int">
	    SELECT COUNT(*)
	    FROM USER
	    WHERE
	    <if test="searchType != null and searchKeyword != null">
	        ${searchType} LIKE #{searchKeyword}
	    </if>
	</select>

	<select id="getUsersPg" resultType="user">
	    SELECT *
	    FROM USER
	    WHERE U_SECESSION = 'N'
	    ORDER BY U_DATE DESC
	    LIMIT #{offset}, #{limit}
	</select>

	<select id="getTotalUserCnt" resultType="int">
	    SELECT COUNT(*)
	    FROM USER
	    WHERE U_SECESSION = 'N'
	</select>



	<!-- 사용자 정보 수정(관리자) -->
	<update id="selUser">
		UPDATE USER
		SET U_NAME = #{u_name},
		U_NICKNAME = #{u_nickname},
		 U_ADDRESS = #{u_address},
		     U_PNO = #{u_pno},
	       U_EMAIL = #{u_email}
		<if test="u_pw != null">
			, U_PW = #{u_pw}
		</if>
		WHERE U_ID = #{u_id}
	</update>

	<!-- 회원 삭제(관리자) -->
	<update id="delUser">
		UPDATE USER
		   SET U_SECESSION = 'Y'
		 WHERE U_ID = #{u_id}
	</update>

	<!-- 관리자 비밀번호 확인(관리자) -->
	<select id="updateAdminChk" resultType="user">
		SELECT U_ID
			 , U_PW
		  FROM USER
		 WHERE U_ID = #{u_id}
	</select>
	
	<!-- 관리자 비밀번호 수정 상세(관리자) -->
	<select id="updateAdminDetail" resultType="user">
		SELECT *
		  FROM USER
		 WHERE U_ID = #{u_id}
	</select>
		
	<!-- 관리자 새 비밀번호로 업데이트(관리자) -->
	<update id="setNewAdminPw" >
	    UPDATE USER
	    SET U_PW = #{u_pw}
	    WHERE U_ID = #{u_id}
	</update>





	<!-- 사용자 메뉴 -->
	<!-- 주문 목록 보기(사용자) -->
	<select id="getBuyList" resultType="orderlist">

       SELECT A.C_NO 
             ,A.O_TOTAL_PRICE
             ,A.O_TOTAL_CNT  
             ,DATE_FORMAT(A.O_INPUT_DATE, '%Y-%m-%d') AS O_INPUT_DATE 
             ,A.O_STATUS
             ,A.O_CANCEL_YN
             ,CONCAT((SELECT C.P_NAME 
                      FROM PRODUCT C 
                      JOIN O_DETAIL B ON C.P_NO = B.P_NO 
                      WHERE B.C_NO = A.C_NO 
                      LIMIT 1), ' 외', A.O_TOTAL_CNT - 1, '건') AS P_NAME
       FROM ORDERLIST A
       WHERE A.U_ID = 'kim1234'
         AND IFNULL(A.O_DELETE_YN, 'N') = 'N'
	</select>
	
	<select id="getBuyListDetail" resultType="orderlist">
		 SELECT A.C_NO,
		        A.O_TOTAL_PRICE,
		        A.O_TOTAL_CNT,
		        DATE_FORMAT(A.O_INPUT_DATE, '%Y-%m-%d') AS O_INPUT_DATE,
		        A.O_STATUS,
		        A.O_CANCEL_YN,
		        (SELECT C.P_NAME 
		           FROM product C 
		          WHERE C.P_NO = B.P_NO
		          LIMIT 1) AS P_NAME,
		        (SELECT C.P_IMG 
		           FROM PRODUCT C 
		          WHERE C.P_NO = B.P_NO
		          LIMIT 1) AS P_IMG,
		        B.P_PRICE,
		        B.P_COUNT,
		        B.P_OPTION,
		        A.O_STATUS,
		        A.O_PAY_TYPE,
		        A.O_ADDRESS,
		        A.O_RECEIVER,
		        A.O_RECEIVER_CONTACT
	    FROM `order` A 
	     JOIN O_DETAIL B ON A.O_NO = B.O_NO
	    WHERE A.U_ID = #{u_id}
	      AND IFNULL(A.O_DELETE_YN, 'N') = 'N'
	      AND A.C_NO = #{o_no}
	</select>
	
	

	<!-- 찜한 상품 목록 조회(사용자) -->
	<select id="getZzimList" resultType="product">
		SELECT P_NAME
			 , P_PRICE
			 , P_IMG
			 , P_NO
	 	  FROM PRODUCT
		 WHERE P_GOOD = 'Y'
	</select>

	<!-- 마이페이지 현재 비밀번호 조회(사용자) -->
	<select id="updateMypageChk" resultType="user">
		SELECT U_ID
			 , U_PW
		  FROM USER
		 WHERE U_ID = #{u_id}
	</select>
	
	<!-- 마이페이지 정보 수정(사용자) -->
	<select id="updateMypageDetail" resultType="user">
		SELECT *
		  FROM USER
		 WHERE U_ID = #{u_id}
	</select>
	
	<!-- 마이페이지 새 정보 업데이트 -->
	<update id="setNewMypage">
		UPDATE USER
	       SET U_NICKNAME = #{u_nickname},
	           U_ADDRESS = #{u_address},
	           U_PNO = #{u_pno},
	           U_EMAIL = #{u_email}
	     WHERE U_ID = #{u_id}
	</update>




	<!-- 비밀번호 조회(사용자) -->
	<select id="updatePasswordChk" resultType="user">
		SELECT U_ID
			 , U_PW
		  FROM USER
		 WHERE U_ID = #{u_id}
	</select>
	
	<!-- 비밀번호 수정 상세(사용자) -->
	<select id="updatePasswordDetail" resultType="user">
		SELECT U_ID
		     , U_PW
		  FROM USER
		 WHERE U_ID = #{u_id}
	</select>
		
	<!-- 새 비밀번호로 업데이트(사용자) -->
	<update id="setNewPassword">
		UPDATE USER
		   SET U_PW = #{u_pw}
		 WHERE U_ID = #{u_id}
	</update>
	
 	<!-- 마이페이지 회원탈퇴(사용자) --> 
	<update id="taltaeUser">
		UPDATE USER
		   SET U_SECESSION = 'Y'
	 	 WHERE U_ID = #{u_id}
	</update>
	
</mapper>
